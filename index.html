<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        #image-output {
            min-height: 300px;
            background-color: #e2e8f0;
            border: 2px dashed #94a3b8;
            transition: all 0.3s ease;
        }
        #image-output img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        /* Custom spinning animation for the loader */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6; /* Blue spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div class="container-card bg-white p-6 md:p-10 w-full max-w-xl rounded-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI Image Creator (Imagen 4.0)</h1>

        <!-- Input Section -->
        <div class="mb-6">
            <label for="prompt-input" class="block text-sm font-medium text-gray-700 mb-2">
                What image would you like to create?
            </label>
            <textarea id="prompt-input" rows="3" placeholder="e.g., A watercolor painting of a futuristic city at sunset, highly detailed."
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out resize-none"></textarea>
        </div>

        <!-- Generate Button -->
        <button id="generate-button"
                class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50"
                onclick="generateImage()">
            Generate Image
        </button>

        <!-- Output and Status Section -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Generated Image</h2>
            <div id="status-message" class="text-center p-3 mb-4 text-sm rounded-lg hidden"></div>

            <div id="image-output"
                 class="relative flex items-center justify-center rounded-lg overflow-hidden">
                <p id="placeholder-text" class="text-gray-500">
                    Your generated image will appear here.
                </p>
                <!-- Loading Spinner Area -->
                <div id="loading-indicator" class="hidden flex flex-col items-center justify-center space-y-3">
                    <div class="spinner"></div>
                    <p class="text-blue-600 font-medium">Generating...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        const apiKey = ""; // API Key is provided by the runtime environment
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict";
        
        // DOM Elements
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const imageOutput = document.getElementById('image-output');
        const loadingIndicator = document.getElementById('loading-indicator');
        const placeholderText = document.getElementById('placeholder-text');
        const statusMessage = document.getElementById('status-message');

        /**
         * Utility function to show status messages.
         * @param {string} message - The text to display.
         * @param {string} type - 'success', 'error', or 'info' for styling.
         */
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            } else { // info
                statusMessage.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        /**
         * Clears all output and status messages.
         */
        function clearOutput() {
            imageOutput.innerHTML = '';
            statusMessage.classList.add('hidden');
        }

        /**
         * Main function to handle image generation via the API.
         */
        async function generateImage() {
            const prompt = promptInput.value.trim();

            if (!prompt) {
                showStatus("Please enter a creative prompt to generate an image.", 'error');
                return;
            }
            
            // 1. Setup UI for Loading State
            clearOutput();
            placeholderText.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;
            showStatus("Sending request to Imagen 4.0...", 'info');

            const payload = {
                instances: [{ prompt: prompt }],
                parameters: {
                    sampleCount: 1,
                    aspectRatio: "1:1", // You can change this, e.g., "16:9"
                }
            };
            
            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // 2. Process the response
                    const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                    if (base64Data) {
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        
                        // 3. Update UI with the image
                        clearOutput();
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = prompt;
                        img.className = "w-full h-full object-contain";
                        imageOutput.appendChild(img);

                        showStatus("Image generated successfully!", 'success');
                        
                        // Break the retry loop on success
                        break; 
                    } else {
                        // Handle case where API call succeeds but returns no data
                        throw new Error("Generation failed: No image data returned.");
                    }

                } catch (error) {
                    attempts++;
                    const delay = Math.pow(2, attempts) * 1000; // Exponential backoff: 2s, 4s, 8s
                    console.error(`Attempt ${attempts} failed:`, error);

                    if (attempts < maxAttempts) {
                        showStatus(`Generation failed. Retrying in ${delay / 1000} seconds...`, 'error');
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // 4. Update UI for final failure
                        clearOutput();
                        placeholderText.classList.remove('hidden');
                        showStatus("Image generation failed after multiple retries. Please try a different prompt.", 'error');
                    }
                }
            }

            // 5. Cleanup UI
            loadingIndicator.classList.add('hidden');
            generateButton.disabled = false;
        }
    </script>
</body>
</html>
